<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>RSMM Sunburst Chart</title>
    <style>
      body {
        font-family: sans-serif;
        background-color: white;
        text-align: center;
      }

      #resetZoom {
        margin-top: 10px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        background-color: #007acc;
        color: white;
        border: none;
        border-radius: 4px;
      }

      path {
        cursor: pointer;
      }

      svg {
        margin-top: 20px;
      }

      .center-label {
        font-size: 16px;
        font-weight: bold;
        fill: #333;
        text-anchor: middle;
      }

      textPath {
        font-size: 10px;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <h2>RSMM Sunburst Visualization</h2>
    <button id="resetZoom">ðŸ”„ Reset Zoom</button>
    <svg width="500" height="500"></svg>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const data = {{ focus_json|safe }};

      const width = 500;
      const radius = width / 2;

      const color = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, 20));

      const partition = data => {
        const root = d3.hierarchy(data)
          .sum(d => d.children ? 0 : 1)
          .sort((a, b) => b.value - a.value);
        return d3.partition().size([2 * Math.PI, radius])(root);
      };

      const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1 - 1);

      const root = partition(data);
      root.each(d => d.current = d);

      const svg = d3.select("svg")
        .attr("viewBox", [0, 0, width, width])
        .style("font", "10px sans-serif");

      const g = svg.append("g")
        .attr("transform", `translate(${width / 2},${width / 2})`);

      const label = g.append("text")
        .attr("class", "center-label")
        .attr("dy", "0.35em")
        .style("cursor", "pointer")
        .text(data.name)
        .on("click", () => clicked(null, root));

      const path = g.append("g")
        .selectAll("path")
        .data(root.descendants().slice(1))
        .join("path")
          .attr("fill", d => color((d.children ? d : d.parent).data.name))
          .attr("d", d => arc(d.current))
          .on("click", clicked);

      path.append("title")
        .text(d => d.ancestors().map(d => d.data.name).reverse().join(" > "));

      // ===== Arc Paths for Curved Labels =====
      const arcLabelPaths = g.append("g")
        .selectAll("path")
        .data(root.descendants().slice(1))
        .join("path")
          .attr("id", (d, i) => `label-path-${i}`)
          .attr("d", d => createArcLabelPath(d))
          .style("fill", "none");

      function createArcLabelPath(d) {
        const midAngle = (d.x0 + d.x1) / 2;
        const flip = midAngle > Math.PI;

        const arcGen = d3.arc()
          .startAngle(flip ? d.x1 : d.x0)
          .endAngle(flip ? d.x0 : d.x1)
          .innerRadius((d.y0 + d.y1) / 2)
          .outerRadius((d.y0 + d.y1) / 2);

        return arcGen(d);
      }

      // ===== Curved Text Labels =====
      const arcLabels = g.append("g")
        .attr("class", "labels")
        .selectAll("text")
        .data(root.descendants().slice(1))
        .join("text")
        .attr("dy", "-0.3em")
        .append("textPath")
          .attr("xlink:href", (d, i) => `#label-path-${i}`)
          .attr("startOffset", d => ((d.x0 + d.x1) / 2) > Math.PI ? "100%" : "50%")
          .attr("text-anchor", d => ((d.x0 + d.x1) / 2) > Math.PI ? "end" : "middle")
          .text(d => {
            const name = d.data.name;
            return name.length > 30 ? name.slice(0, 27) + "..." : name;
          })
          .style("display", d => showLabel(d) ? null : "none");

      function showLabel(d) {
        const angle = d.x1 - d.x0;
        const radiusSpan = d.y1 - d.y0;
        return angle > 0.03 && radiusSpan > 10;
      }

      function clicked(event, p) {
        root.each(d => d.target = {
          x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
          x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
          y0: Math.max(0, d.y0 - p.y0),
          y1: Math.max(0, d.y1 - p.y0)
        });

        const t = g.transition().duration(750);

        path.transition(t)
          .attrTween("d", d => {
            const i = d3.interpolate(d.current, d.target);
            return t => (d.current = i(t), arc(d.current));
          });

        arcLabelPaths.transition(t)
          .attrTween("d", d => {
            const i = d3.interpolate(d.current, d.target);
            return t => createArcLabelPath(i(t));
          });

        arcLabels.transition(t)
          .style("display", d => showLabel(d.target) ? null : "none");

        label.text(p.data.name);
      }

      document.getElementById("resetZoom").addEventListener("click", () => clicked(null, root));
    </script>
  </body>
</html>
